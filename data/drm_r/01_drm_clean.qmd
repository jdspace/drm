---
title: "01_drm_clean"
author: "Jeremy Faulk"
format: html
editor: visual
---

## Setup

```{r setup, include=FALSE}
# ğŸ“¦ Load helpful libraries
library(here)
library(readxl)
library(janitor)
library(tidyverse)
library(scales)
library(knitr)

# ğŸ“Œ Declare project root for 'here' (only needed once per session)
here::i_am("data/drm_r/01_drm_clean.qmd")
```

##ğŸ“¥ Load Combined DRM Dataset

```{r}
# ğŸ” Define and read the combined DRM data file
path <- here("data", "drm_merged", "drm_qualtrics_quantitative.csv")
if (!file.exists(path)) stop("File not found: ", path)
# First row is column label
df <- read_csv(path)

# ğŸ‘€ Preview structure
df %>%
  slice_head(n = 10)
```

##ğŸ§¼ Clean and Standardize

```{r}
# ğŸ—‘ï¸ Remove metadata/question label rows
df <- df[-c(2, 75, 81, 85, 90, 92, 95), ]

# ğŸ§½ Standardize column names
df <- clean_names(df)

# ğŸš® Remove junk rows that start with '{\"ImportId\":' in the SONA column
df <- df %>%
  filter(!str_detect(sona, "^\\{\"ImportId\":"))

# âœ… Confirm remaining rows
cat("Remaining rows after removing junk entries:", nrow(df), "\n")

# ğŸ§¼ Normalize SONA values (lowercase + trim whitespace)
df <- df %>%
  mutate(sona = str_trim(tolower(sona)))

# ğŸ§¾ SONA IDs to exclude (also lowercase to match)
drop_ids <- tolower(c(
  "Jps395@cornell.edu", "Njw75@cornell.edu", "92419", "87832", 
  "bjl99@cornell.edu", "74467", "Kl547@cornell.edu", "86920", 
  "km656@cornell.edu", "71665", "93025"
))

# ğŸš« Filter out excluded participants
df <- df %>%
  filter(!(sona %in% drop_ids))

# âœ… Check result
cat("Remaining rows after exclusion:", nrow(df), "\n")

# ğŸ§½ Remove duplicate suffixes (keep only .x columns if .y exists)
df <- df %>%
  select(-matches("\\.y$")) %>%  # Drop columns ending in .y
  rename_with(~ str_remove(., "\\.x$"), matches("\\.x$"))  # Remove .x from column names


# ğŸ§¬ Group by SONA and coalesce values across duplicate rows
df_merged <- df %>%
  group_by(sona) %>%
  summarise(across(everything(), ~ suppressWarnings(na.omit(.x)[1])), .groups = "drop")

# ğŸ§¾ Check number of unique vs original SONA rows
cat("Original rows:", nrow(df), "\n")
cat("After merge:", nrow(df_merged), "\n")

# ğŸªŸ View a few cases to verify
df_merged %>% filter(sona %in% c("78559", "72349")) %>% View()

# âœ… Confirm remaining rows
cat("Remaining rows after coalescing duplicate sona entries:", nrow(df), "\n")
```

## ğŸš« Drop Participants Without Episode-Level Data

```{r}

# ğŸ§¼ Drop rows where `sona` matches any in `drop_ids`
df <- df %>% 
  filter(!(sona %in% drop_ids))

# âœ… Confirm how many rows remain
cat("Remaining participants after exclusion:", nrow(df), "\n")
```

##âœ… ğŸ” Flag Missing SONA IDs

```{r}
df <- df %>%
  mutate(sona_status = case_when(
    is.na(sona) ~ "missing",
    TRUE ~ "present"
  ))

# ğŸ”¢ Count how many are missing
table(df$sona_status)
```

## ğŸ“Š Export Summary Statistics

```{r}
# ğŸ“‹ Create a summary table
summary_df <- as.data.frame(summary(df))

# ğŸ’¾ Define output file path
output_file <- here("data", "drm_r", "outputs", paste0("summary_", Sys.Date(), ".csv"))

# ğŸ“¤ Save to outputs folder
write_csv(summary_df, output_file)
```

## Manual Instructions to Commit to GitHub (i.e., not auto)

```{text}
# ğŸš€ Manually run this chunk when you're ready to commit

# Set your commit message manually here
message <- "Quick update via Quarto chunk"

# Commit and push to GitHub
system("git add .")
system(paste('git commit -m', shQuote(message)))
system("git push")

---
### ğŸ§  Why `eval=FALSE`?

# - So the commit isnâ€™t triggered **automatically** every time you render.
# - Youâ€™ll run this chunk manually (e.g., click the green â–¶ï¸ in the corner), **when** you want to push to GitHub.

```
--------------------

## ğŸš« .gitignore Reference

```{text}
# RStudio project files
.Rproj.user/
.Rhistory
.RData
.DS_Store

# Quarto/knitr cache and output
*_cache/
*_files/

# Rendered output files
outputs/
*.html
*.pdf
*.docx

# Raw data
data/*.csv
data/*.xlsx
```

## ğŸš§ Identify Numeric Variables

```{r}
# ğŸ” Identify numeric columns
numeric_cols <- df %>%
  select(where(is.numeric)) %>%
  names()

# ğŸ§¾ Print the list
print(numeric_cols)

# ğŸ” Preview data from first 5 numeric columns (10 rows)
df %>%
  select(all_of(head(numeric_cols, 5))) %>%
  slice_head(n = 10)

# ğŸ” Try to convert character columns to numeric where possible
df <- df %>%
  mutate(across(where(is.character), ~ suppressWarnings(as.numeric(.x)), .names = "num_{.col}"))

# ğŸ” Now select the newly created numeric columns
numeric_cols <- df %>%
  select(starts_with("num_")) %>%
  names()

# ğŸ§¾ Confirm that it worked
print(numeric_cols)
```

## ğŸš¨ Flag Potential Outliers (Â±3 SD)

```{r}
# âš ï¸ Flag outliers using Â±3 SD rule
outlier_df <- df %>%
  select(all_of(numeric_cols)) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  mutate(
    mean_val = mean(value, na.rm = TRUE),
    sd_val   = sd(value, na.rm = TRUE),
    is_outlier = abs(value - mean_val) > 3 * sd_val
  ) %>%
  filter(is_outlier)

# ğŸ§¾ Show top rows of flagged outliers
head(outlier_df)
```

